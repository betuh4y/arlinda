<!DOCTYPE html>
<html lang="pt-BR">

  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gestão Financeira</title>
    <!-- Font Awesome para ícones -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <style>
      :root {
        --bg-color: #f4f4f4;
        --card-bg: #ffffff;
        --text-color: #333;
        --button-bg: #007bff;
        --button-hover: #0056b3;
        --export-button-bg: #28a745;
        --export-button-hover: #218838;
        --border-color: #ddd;
        --shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      [data-theme="dark"] {
        --bg-color: #1a1a1a;
        --card-bg: #2c2c2c;
        --text-color: #e0e0e0;
        --border-color: #444;
        --shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      }

      * {
        box-sizing: border-box;
      }

      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background-color: var(--bg-color);
        color: var(--text-color);
        transition: background-color 0.3s, color 0.3s;
      }

      h2,
      h3 {
        color: var(--text-color);
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
      }

      .card {
        background-color: var(--card-bg);
        padding: 20px;
        margin-bottom: 20px;
        border-radius: 8px;
        box-shadow: var(--shadow);
        border: 1px solid var(--border-color);
      }

      input[type="email"],
      input[type="password"],
      input[type="date"],
      input[type="text"],
      input[type="number"],
      select,
      textarea {
        width: 100%;
        padding: 12px;
        margin-bottom: 15px;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        font-size: 16px;
        background-color: var(--card-bg);
        color: var(--text-color);
      }

      button {
        background-color: var(--button-bg);
        color: white;
        padding: 12px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: background-color 0.2s;
      }

      button:hover {
        background-color: var(--button-hover);
      }

      .download-buttons button,
      .report-section button {
        background-color: var(--export-button-bg);
      }

      .download-buttons button:hover,
      .report-section button:hover {
        background-color: var(--export-button-hover);
      }

      #bankList .card,
      #incomeList .card,
      #transferList .card,
      #expenseList .card,
      #lendingList .card,
      #peopleList .card {
        margin-top: 15px;
        padding: 15px;
      }

      .installment-card {
        background-color: var(--card-bg);
        padding: 10px;
        margin-top: 10px;
        border: 1px solid var(--border-color);
        border-radius: 4px;
      }

      .report-section input[type="text"] {
        width: 100%;
        max-width: 300px;
        display: inline-block;
        margin-right: 10px;
      }

      .theme-toggle {
        position: fixed;
        top: 20px;
        right: 20px;
        background-color: transparent;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: var(--text-color);
      }

      /* Estilos para accordion em mobile */
      .accordion-header {
        display: none;
        cursor: pointer;
        padding: 10px;
        background-color: var(--button-bg);
        color: white;
        border-radius: 4px;
        margin-bottom: 10px;
      }

      .accordion-content {
        display: block;
      }

      /* Responsividade */
      @media (max-width: 768px) {
        body {
          margin: 10px;
        }

        .container {
          padding: 0 10px;
        }

        input[type="email"],
        input[type="password"],
        input[type="date"],
        input[type="text"],
        input[type="number"],
        select,
        textarea {
          font-size: 14px;
          padding: 10px;
        }

        button {
          font-size: 14px;
          padding: 10px 15px;
          width: 100%;
          margin-bottom: 10px;
        }

        .report-section input[type="text"] {
          max-width: 100%;
          margin-bottom: 10px;
        }

        .accordion-header {
          display: block;
        }

        .accordion-content {
          display: none;
        }

        .accordion-content.active {
          display: block;
        }
      }
    </style>
    <script type="text/javascript" src="./index.js" defer=""></script>
    <link rel="stylesheet" href="./index.css">
  </head>

  <body>
    <button class="theme-toggle" id="themeToggle" title="Alternar Modo Claro/Escuro">
      <i class="fas fa-moon"></i>
    </button>
    <div class="container">
      <h2>Sistema de Gestão Financeira</h2>
      <div id="authSection" class="card">
        <h3>Login / Cadastro</h3>
        <input type="email" id="email" placeholder="Email">
        <input type="password" id="password" placeholder="Senha">
        <button id="registerBtn"><i class="fas fa-user-plus"></i> Cadastrar</button>
        <button id="loginBtn"><i class="fas fa-sign-in-alt"></i> Entrar</button>
      </div>
      <div id="financeSection" style="display: none;">
        <!-- Seção de Bancos -->
        <div class="card">
          <h3 class="accordion-header">Gerenciar Bancos</h3>
          <div class="accordion-content active">
            <div class="card">
              <h4>Adicionar Banco</h4>
              <input type="text" id="bankName" placeholder="Nome do Banco">
              <input type="number" id="bankBalance" placeholder="Saldo Inicial" value="0">
              <button id="submitBank"><i class="fas fa-save"></i> Salvar Banco</button>
            </div>
            <div class="card">
              <h3>Seus Bancos</h3>
              <div id="bankList"></div>
            </div>
          </div>
        </div>
        <!-- Seção de Pessoas -->
        <div class="card">
          <h3 class="accordion-header">Gerenciar Pessoas</h3>
          <div class="accordion-content active">
            <div class="card">
              <h4>Adicionar Pessoa</h4>
              <input type="text" id="personName" placeholder="Nome da Pessoa">
              <input type="text" id="personPhone" placeholder="Telefone (opcional)">
              <button id="submitPerson"><i class="fas fa-save"></i> Salvar Pessoa</button>
            </div>
            <div class="card">
              <h3>Suas Pessoas Registradas</h3>
              <div id="peopleList"></div>
            </div>
          </div>
        </div>
        <!-- Seção de Entradas de Dinheiro -->
        <div class="card">
          <h3 class="accordion-header">Registrar Entrada de Dinheiro</h3>
          <div class="accordion-content active">
            <div class="card">
              <h4>Informações da Entrada</h4>
              <input type="date" id="incomeDate" placeholder="Data da Entrada">
              <input type="number" id="incomeAmount" placeholder="Valor">
              <select id="incomeType">
                <option value="pix">PIX</option>
                <option value="cash">Dinheiro Físico</option>
              </select>
              <select id="incomeBank"></select>
              <button id="submitIncome"><i class="fas fa-save"></i> Salvar Entrada</button>
            </div>
            <div class="card">
              <h3>Suas Entradas</h3>
              <div id="incomeList"></div>
            </div>
          </div>
        </div>
        <!-- Seção de Transferências -->
        <div class="card">
          <h3 class="accordion-header">Registrar Transferência</h3>
          <div class="accordion-content active">
            <div class="card">
              <h4>Informações da Transferência</h4>
              <input type="date" id="transferDate" placeholder="Data da Transferência">
              <select id="fromBank"></select>
              <select id="toBank"></select>
              <input type="number" id="transferAmount" placeholder="Valor">
              <button id="submitTransfer"><i class="fas fa-save"></i> Salvar Transferência</button>
            </div>
            <div class="card">
              <h3>Suas Transferências</h3>
              <div id="transferList"></div>
            </div>
          </div>
        </div>
        <!-- Seção de Gastos -->
        <div class="card">
          <h3 class="accordion-header">Registrar Gasto</h3>
          <div class="accordion-content active">
            <div class="card">
              <h4>Informações do Gasto</h4>
              <input type="date" id="expenseDate" placeholder="Data do Gasto">
              <input type="number" id="expenseAmount" placeholder="Valor">
              <select id="expenseCategory">
                <option value="uber">Uber</option>
                <option value="clothes">Roupa</option>
                <option value="market">Feira/Mercado</option>
                <option value="other">Outro</option>
              </select>
              <input type="text" id="expenseDescription" placeholder="Descrição (opcional)">
              <select id="expenseBank"></select>
              <button id="submitExpense"><i class="fas fa-save"></i> Salvar Gasto</button>
            </div>
            <div class="card">
              <h3>Seus Gastos</h3>
              <div id="expenseList"></div>
            </div>
          </div>
        </div>
        <!-- Seção de Empréstimos -->
        <div class="card">
          <h3 class="accordion-header">Registrar Empréstimo de Dinheiro</h3>
          <div class="accordion-content active">
            <div class="card">
              <h4>Informações do Empréstimo</h4>
              <select id="lendingPersonId"></select>
              <input type="number" id="lendingAmount" placeholder="Valor Total Emprestado">
              <input type="number" id="lendingInstallments" placeholder="Número de Parcelas">
              <input type="date" id="lendingStartDate" placeholder="Data de Início">
              <input type="text" id="lendingEndDate" placeholder="Data de Término (calculada)" readonly="">
              <button id="submitLending"><i class="fas fa-save"></i> Salvar Empréstimo</button>
            </div>
            <div class="card">
              <h3>Seus Empréstimos</h3>
              <div id="lendingList"></div>
            </div>
          </div>
        </div>
        <!-- Exportações -->
        <div class="card">
          <h3 class="accordion-header">Exportar Relatórios</h3>
          <div class="accordion-content active download-buttons">
            <button id="exportPdfBtn"><i class="fas fa-file-pdf"></i> Baixar PDF</button>
            <button id="exportExcelBtn"><i class="fas fa-file-excel"></i> Baixar Excel</button>
          </div>
        </div>
        <!-- Enviar Relatório -->
        <div class="card">
          <h3 class="accordion-header">Enviar Relatório por Número</h3>
          <div class="accordion-content active report-section">
            <input type="text" id="phoneNumber" placeholder="Número de Telefone (Ex: 5511987654321)" title="Formato: Código do país + DDD + Número. Ex: 5511987654321">
            <button id="sendReportBtn"><i class="fas fa-paper-plane"></i> Enviar Relatório</button>
            <small>Para WhatsApp, use o formato completo com código do país (ex: 55 para Brasil).</small>
          </div>
        </div>
        <button id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Sair</button>
      </div>
    </div>
    <script type="module">
      import {
        initializeApp
      } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
      import {
        getAuth,
        createUserWithEmailAndPassword,
        signInWithEmailAndPassword,
        onAuthStateChanged,
        signOut
      } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
      import {
        getDatabase,
        ref,
        push,
        set,
        update,
        onValue,
        remove
      } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";
      const firebaseConfig = {
        apiKey: "AIzaSyDJBdK9I-jtg9ujTc9Xsxr-hnPfkId4wIU",
        authDomain: "pdv1-77632.firebaseapp.com",
        databaseURL: "https://pdv1-77632-default-rtdb.firebaseio.com",
        projectId: "pdv1-77632",
        storageBucket: "pdv1-77632.firebasestorage.app",
        messagingSenderId: "246033791117",
        appId: "1:246033791117:web:7b70b511ea8d8c5ba1cac4",
        measurementId: "G-NTG13SG6VM"
      };
      const app = initializeApp(firebaseConfig);
      const auth = getAuth();
      const db = getDatabase();
      let editId = null;
      let currentData = {
        banks: [],
        people: [],
        incomes: [],
        transfers: [],
        expenses: [],
        lendings: []
      };

      // Funções de autenticação
      document.getElementById("registerBtn").onclick = () => {
        const email = document.getElementById("email").value;
        const password = document.getElementById("password").value;
        createUserWithEmailAndPassword(auth, email, password)
          .then(() => alert("Usuário registrado!"))
          .catch(err => alert(err.message));
      };
      document.getElementById("loginBtn").onclick = () => {
        const email = document.getElementById("email").value;
        const password = document.getElementById("password").value;
        signInWithEmailAndPassword(auth, email, password)
          .then(() => alert("Login realizado!"))
          .catch(err => alert(err.message));
      };
      document.getElementById("logoutBtn").onclick = () => {
        signOut(auth);
      };
      onAuthStateChanged(auth, user => {
        if (user) {
          document.getElementById("authSection").style.display = "none";
          document.getElementById("financeSection").style.display = "block";
          loadAllData(user.uid);
        } else {
          document.getElementById("authSection").style.display = "block";
          document.getElementById("financeSection").style.display = "none";
        }
      });

      // Função para carregar todos os dados
      function loadAllData(uid) {
        loadBanks(uid);
        loadPeople(uid);
        loadIncomes(uid);
        loadTransfers(uid);
        loadExpenses(uid);
        loadLendings(uid);
      }

      // Gerenciar Bancos
      function loadBanks(uid) {
        const banksRef = ref(db, `financas/${uid}/banks`);
        onValue(banksRef, snapshot => {
          const container = document.getElementById("bankList");
          container.innerHTML = "";
          currentData.banks = [];
          const incomeBankSelect = document.getElementById("incomeBank");
          const fromBankSelect = document.getElementById("fromBank");
          const toBankSelect = document.getElementById("toBank");
          const expenseBankSelect = document.getElementById("expenseBank");
          incomeBankSelect.innerHTML = '<option value="">Selecione Banco</option>';
          fromBankSelect.innerHTML = '<option value="">De</option>';
          toBankSelect.innerHTML = '<option value="">Para</option>';
          expenseBankSelect.innerHTML = '<option value="">Banco Usado</option>';
          if (snapshot.exists()) {
            const data = snapshot.val();
            Object.entries(data).forEach(([key, item]) => {
              currentData.banks.push({
                id: key,
                ...item
              });
              const div = document.createElement("div");
              div.className = "card";
              div.innerHTML = `
                <strong>Nome:</strong> ${item.name}<br>
                <strong>Saldo:</strong> R$ ${item.balance.toFixed(2)}<br>
                <button onclick="editBank('${key}')"><i class="fas fa-edit"></i> Editar</button>
                <button onclick="deleteBank('${key}')"><i class="fas fa-trash"></i> Excluir</button>
              `;
              container.appendChild(div);
              const option = document.createElement("option");
              option.value = key;
              option.text = item.name;
              incomeBankSelect.appendChild(option.cloneNode(true));
              fromBankSelect.appendChild(option.cloneNode(true));
              toBankSelect.appendChild(option.cloneNode(true));
              expenseBankSelect.appendChild(option.cloneNode(true));
            });
          } else {
            container.innerHTML = "Nenhum banco cadastrado.";
          }
        });
      }
      document.getElementById("submitBank").onclick = () => {
        const name = document.getElementById("bankName").value;
        const balance = parseFloat(document.getElementById("bankBalance").value) || 0;
        const data = {
          name,
          balance
        };
        const user = auth.currentUser;
        if (user) {
          const baseRef = ref(db, `financas/${user.uid}/banks`);
          if (editId) {
            update(ref(db, `financas/${user.uid}/banks/${editId}`), data).then(() => {
              alert("Banco atualizado!");
              editId = null;
              clearBankForm();
              loadBanks(user.uid);
            });
          } else {
            push(baseRef).then(newRef => {
              set(newRef, data).then(() => {
                alert("Banco cadastrado!");
                clearBankForm();
                loadBanks(user.uid);
              });
            });
          }
        }
      };
      window.editBank = (id) => {
        const item = currentData.banks.find(b => b.id === id);
        if (item) {
          document.getElementById("bankName").value = item.name;
          document.getElementById("bankBalance").value = item.balance;
          editId = id;
        }
      };
      window.deleteBank = (id) => {
        if (confirm("Excluir banco?")) {
          remove(ref(db, `financas/${auth.currentUser.uid}/banks/${id}`)).then(() => {
            loadBanks(auth.currentUser.uid);
          });
        }
      };

      function clearBankForm() {
        document.getElementById("bankName").value = "";
        document.getElementById("bankBalance").value = "0";
      }

      // Gerenciar Pessoas
      function loadPeople(uid) {
        const peopleRef = ref(db, `financas/${uid}/people`);
        onValue(peopleRef, snapshot => {
          const container = document.getElementById("peopleList");
          container.innerHTML = "";
          currentData.people = [];
          const lendingPersonSelect = document.getElementById("lendingPersonId");
          lendingPersonSelect.innerHTML = '<option value="">Selecione Pessoa</option>';
          if (snapshot.exists()) {
            const data = snapshot.val();
            Object.entries(data).forEach(([key, item]) => {
              currentData.people.push({
                id: key,
                ...item
              });
              const div = document.createElement("div");
              div.className = "card";
              div.innerHTML = `
                <strong>Nome:</strong> ${item.name}<br>
                <strong>Telefone:</strong> ${item.phone || 'N/A'}<br>
                <button onclick="editPerson('${key}')"><i class="fas fa-edit"></i> Editar</button>
                <button onclick="deletePerson('${key}')"><i class="fas fa-trash"></i> Excluir</button>
              `;
              container.appendChild(div);
              const option = document.createElement("option");
              option.value = key;
              option.text = item.name;
              lendingPersonSelect.appendChild(option);
            });
          } else {
            container.innerHTML = "Nenhuma pessoa cadastrada.";
          }
        });
      }
      document.getElementById("submitPerson").onclick = () => {
        const name = document.getElementById("personName").value;
        const phone = document.getElementById("personPhone").value;
        const data = {
          name,
          phone
        };
        const user = auth.currentUser;
        if (user && name) {
          const baseRef = ref(db, `financas/${user.uid}/people`);
          if (editId) {
            update(ref(db, `financas/${user.uid}/people/${editId}`), data).then(() => {
              alert("Pessoa atualizada!");
              editId = null;
              clearPersonForm();
              loadPeople(user.uid);
            });
          } else {
            push(baseRef).then(newRef => {
              set(newRef, data).then(() => {
                alert("Pessoa cadastrada!");
                clearPersonForm();
                loadPeople(user.uid);
              });
            });
          }
        }
      };
      window.editPerson = (id) => {
        const item = currentData.people.find(p => p.id === id);
        if (item) {
          document.getElementById("personName").value = item.name;
          document.getElementById("personPhone").value = item.phone || '';
          editId = id;
        }
      };
      window.deletePerson = (id) => {
        if (confirm("Excluir pessoa?")) {
          remove(ref(db, `financas/${auth.currentUser.uid}/people/${id}`)).then(() => {
            loadPeople(auth.currentUser.uid);
          });
        }
      };

      function clearPersonForm() {
        document.getElementById("personName").value = "";
        document.getElementById("personPhone").value = "";
      }

      // Entradas de Dinheiro
      function loadIncomes(uid) {
        const incomesRef = ref(db, `financas/${uid}/incomes`);
        onValue(incomesRef, snapshot => {
          const container = document.getElementById("incomeList");
          container.innerHTML = "";
          currentData.incomes = [];
          if (snapshot.exists()) {
            const data = snapshot.val();
            Object.entries(data).forEach(([key, item]) => {
              currentData.incomes.push({
                id: key,
                ...item
              });
              const div = document.createElement("div");
              div.className = "card";
              div.innerHTML = `
                <strong>Data:</strong> ${formatDate(item.date)}<br>
                <strong>Valor:</strong> R$ ${item.amount.toFixed(2)}<br>
                <strong>Tipo:</strong> ${item.type}<br>
                <strong>Banco:</strong> ${item.bankId ? getBankName(item.bankId) : 'N/A'}<br>
                <button onclick="deleteIncome('${key}')"><i class="fas fa-trash"></i> Excluir</button>
              `;
              container.appendChild(div);
            });
          } else {
            container.innerHTML = "Nenhuma entrada registrada.";
          }
        });
      }
      document.getElementById("submitIncome").onclick = () => {
        const date = document.getElementById("incomeDate").value;
        const amount = parseFloat(document.getElementById("incomeAmount").value) || 0;
        const type = document.getElementById("incomeType").value;
        const bankId = document.getElementById("incomeBank").value;
        const data = {
          date,
          amount,
          type,
          bankId
        };
        const user = auth.currentUser;
        if (user && amount > 0) {
          push(ref(db, `financas/${user.uid}/incomes`)).then(newRef => {
            set(newRef, data).then(() => {
              if (bankId) {
                updateBankBalance(user.uid, bankId, amount, true);
              }
              alert("Entrada registrada!");
              clearIncomeForm();
              loadIncomes(user.uid);
            });
          });
        }
      };
      window.deleteIncome = (id) => {
        if (confirm("Excluir entrada?")) {
          onValue(ref(db, `financas/${auth.currentUser.uid}/incomes/${id}`), snapshot => {
            const item = snapshot.val();
            if (item.bankId) {
              updateBankBalance(auth.currentUser.uid, item.bankId, item.amount, false);
            }
            remove(ref(db, `financas/${auth.currentUser.uid}/incomes/${id}`)).then(() => {
              loadIncomes(auth.currentUser.uid);
            });
          }, {
            onlyOnce: true
          });
        }
      };

      function clearIncomeForm() {
        document.getElementById("incomeDate").value = "";
        document.getElementById("incomeAmount").value = "";
        document.getElementById("incomeType").value = "pix";
        document.getElementById("incomeBank").value = "";
      }

      // Transferências
      function loadTransfers(uid) {
        const transfersRef = ref(db, `financas/${uid}/transfers`);
        onValue(transfersRef, snapshot => {
          const container = document.getElementById("transferList");
          container.innerHTML = "";
          currentData.transfers = [];
          if (snapshot.exists()) {
            const data = snapshot.val();
            Object.entries(data).forEach(([key, item]) => {
              currentData.transfers.push({
                id: key,
                ...item
              });
              const div = document.createElement("div");
              div.className = "card";
              div.innerHTML = `
                <strong>Data:</strong> ${formatDate(item.date)}<br>
                <strong>De:</strong> ${getBankName(item.fromBankId)}<br>
                <strong>Para:</strong> ${getBankName(item.toBankId)}<br>
                <strong>Valor:</strong> R$ ${item.amount.toFixed(2)}<br>
                <button onclick="deleteTransfer('${key}')"><i class="fas fa-trash"></i> Excluir</button>
              `;
              container.appendChild(div);
            });
          } else {
            container.innerHTML = "Nenhuma transferência registrada.";
          }
        });
      }
      document.getElementById("submitTransfer").onclick = () => {
        const date = document.getElementById("transferDate").value;
        const fromBankId = document.getElementById("fromBank").value;
        const toBankId = document.getElementById("toBank").value;
        const amount = parseFloat(document.getElementById("transferAmount").value) || 0;
        if (fromBankId === toBankId || amount <= 0 || !fromBankId || !toBankId) {
          alert("Dados inválidos.");
          return;
        }
        const data = {
          date,
          fromBankId,
          toBankId,
          amount
        };
        const user = auth.currentUser;
        if (user) {
          push(ref(db, `financas/${user.uid}/transfers`)).then(newRef => {
            set(newRef, data).then(() => {
              updateBankBalance(user.uid, fromBankId, amount, false);
              updateBankBalance(user.uid, toBankId, amount, true);
              alert("Transferência registrada!");
              clearTransferForm();
              loadTransfers(user.uid);
            });
          });
        }
      };
      window.deleteTransfer = (id) => {
        if (confirm("Excluir transferência?")) {
          onValue(ref(db, `financas/${auth.currentUser.uid}/transfers/${id}`), snapshot => {
            const item = snapshot.val();
            updateBankBalance(auth.currentUser.uid, item.fromBankId, item.amount, true);
            updateBankBalance(auth.currentUser.uid, item.toBankId, item.amount, false);
            remove(ref(db, `financas/${auth.currentUser.uid}/transfers/${id}`)).then(() => {
              loadTransfers(auth.currentUser.uid);
            });
          }, {
            onlyOnce: true
          });
        }
      };

      function clearTransferForm() {
        document.getElementById("transferDate").value = "";
        document.getElementById("fromBank").value = "";
        document.getElementById("toBank").value = "";
        document.getElementById("transferAmount").value = "";
      }

      // Gastos
      function loadExpenses(uid) {
        const expensesRef = ref(db, `financas/${uid}/expenses`);
        onValue(expensesRef, snapshot => {
          const container = document.getElementById("expenseList");
          container.innerHTML = "";
          currentData.expenses = [];
          if (snapshot.exists()) {
            const data = snapshot.val();
            Object.entries(data).forEach(([key, item]) => {
              currentData.expenses.push({
                id: key,
                ...item
              });
              const div = document.createElement("div");
              div.className = "card";
              div.innerHTML = `
                <strong>Data:</strong> ${formatDate(item.date)}<br>
                <strong>Valor:</strong> R$ ${item.amount.toFixed(2)}<br>
                <strong>Categoria:</strong> ${item.category}<br>
                <strong>Descrição:</strong> ${item.description || 'N/A'}<br>
                <strong>Banco:</strong> ${item.bankId ? getBankName(item.bankId) : 'N/A'}<br>
                <button onclick="deleteExpense('${key}')"><i class="fas fa-trash"></i> Excluir</button>
              `;
              container.appendChild(div);
            });
          } else {
            container.innerHTML = "Nenhum gasto registrado.";
          }
        });
      }
      document.getElementById("submitExpense").onclick = () => {
        const date = document.getElementById("expenseDate").value;
        const amount = parseFloat(document.getElementById("expenseAmount").value) || 0;
        const category = document.getElementById("expenseCategory").value;
        const description = document.getElementById("expenseDescription").value;
        const bankId = document.getElementById("expenseBank").value;
        const data = {
          date,
          amount,
          category,
          description,
          bankId
        };
        const user = auth.currentUser;
        if (user && amount > 0) {
          push(ref(db, `financas/${user.uid}/expenses`)).then(newRef => {
            set(newRef, data).then(() => {
              if (bankId) {
                updateBankBalance(user.uid, bankId, amount, false);
              }
              alert("Gasto registrado!");
              clearExpenseForm();
              loadExpenses(user.uid);
            });
          });
        }
      };
      window.deleteExpense = (id) => {
        if (confirm("Excluir gasto?")) {
          onValue(ref(db, `financas/${auth.currentUser.uid}/expenses/${id}`), snapshot => {
            const item = snapshot.val();
            if (item.bankId) {
              updateBankBalance(auth.currentUser.uid, item.bankId, item.amount, true);
            }
            remove(ref(db, `financas/${auth.currentUser.uid}/expenses/${id}`)).then(() => {
              loadExpenses(user.uid);
            });
          }, {
            onlyOnce: true
          });
        }
      };

      function clearExpenseForm() {
        document.getElementById("expenseDate").value = "";
        document.getElementById("expenseAmount").value = "";
        document.getElementById("expenseCategory").value = "uber";
        document.getElementById("expenseDescription").value = "";
        document.getElementById("expenseBank").value = "";
      }

      // Empréstimos de Dinheiro
      function loadLendings(uid) {
        const lendingsRef = ref(db, `financas/${uid}/lendings`);
        onValue(lendingsRef, snapshot => {
          const container = document.getElementById("lendingList");
          container.innerHTML = "";
          currentData.lendings = [];
          if (snapshot.exists()) {
            const data = snapshot.val();
            Object.entries(data).forEach(([key, item]) => {
              currentData.lendings.push({
                id: key,
                ...item
              });
              const div = document.createElement("div");
              div.className = "card";
              div.innerHTML = `
                <strong>Pessoa:</strong> ${getPersonName(item.personId)}<br>
                <strong>Valor Total:</strong> R$ ${item.amount.toFixed(2)}<br>
                <strong>Data Início:</strong> ${formatDate(item.startDate)}<br>
                <strong>Data Término:</strong> ${formatDate(item.endDate)}<br>
                <strong>Parcelas:</strong> ${item.installmentsCount}<br>
                <button onclick="editLending('${key}')"><i class="fas fa-edit"></i> Editar</button>
                <button onclick="deleteLending('${key}')"><i class="fas fa-trash"></i> Excluir</button>
                <h4>Parcelas:</h4>
                <div id="installments-${key}"></div>
              `;
              container.appendChild(div);
              loadInstallments(uid, key);
            });
          } else {
            container.innerHTML = "Nenhum empréstimo registrado.";
          }
        });
      }

      function loadInstallments(uid, lendingId) {
        const installmentsRef = ref(db, `financas/${uid}/lendings/${lendingId}/installments`);
        onValue(installmentsRef, snapshot => {
          const container = document.getElementById(`installments-${lendingId}`);
          container.innerHTML = "";
          if (snapshot.exists()) {
            const data = snapshot.val();
            Object.entries(data).forEach(([instKey, instItem]) => {
              const instDiv = document.createElement("div");
              instDiv.className = "installment-card";
              instDiv.innerHTML = `
                <strong>Parcela ${instItem.number}:</strong><br>
                <strong>Valor:</strong> R$ ${instItem.amount.toFixed(2)}<br>
                <strong>Vencimento:</strong> ${formatDate(instItem.dueDate)}<br>
                <strong>Status:</strong> ${instItem.status}<br>
              `;
              if (instItem.status === 'pending') {
                instDiv.innerHTML += `<button onclick="markInstallmentPaid('${lendingId}', '${instKey}')"><i class="fas fa-check"></i> Marcar Pago</button>`;
              }
              instDiv.innerHTML += `<button onclick="editInstallment('${lendingId}', '${instKey}', ${instItem.amount}, '${instItem.dueDate}')"><i class="fas fa-edit"></i> Editar</button>`;
              container.appendChild(instDiv);
            });
          } else {
            container.innerHTML = "Nenhuma parcela gerada.";
          }
        });
      }

      // Calcular data de término automaticamente
      function calculateEndDate() {
        const startDateStr = document.getElementById("lendingStartDate").value;
        const installments = parseInt(document.getElementById("lendingInstallments").value) || 1;
        if (startDateStr) {
          const start = new Date(startDateStr);
          start.setMonth(start.getMonth() + (installments - 1));
          const endDateStr = start.toISOString().split('T')[0];
          document.getElementById("lendingEndDate").value = formatDate(endDateStr);
        } else {
          document.getElementById("lendingEndDate").value = "";
        }
      }

      document.getElementById("lendingStartDate").addEventListener("input", calculateEndDate);
      document.getElementById("lendingInstallments").addEventListener("input", calculateEndDate);

      document.getElementById("submitLending").onclick = () => {
        const personId = document.getElementById("lendingPersonId").value;
        const amount = parseFloat(document.getElementById("lendingAmount").value) || 0;
        const installmentsCount = parseInt(document.getElementById("lendingInstallments").value) || 1;
        const startDate = document.getElementById("lendingStartDate").value;
        const endDate = calculateEndDateFromStart(startDate, installmentsCount);
        const data = {
          personId,
          amount,
          startDate,
          endDate,
          installmentsCount
        };
        const user = auth.currentUser;
        if (user && amount > 0 && personId && installmentsCount > 0 && startDate) {
          const baseRef = ref(db, `financas/${user.uid}/lendings`);
          if (editId) {
            update(ref(db, `financas/${user.uid}/lendings/${editId}`), data).then(() => {
              alert("Empréstimo atualizado! Nota: Parcelas existentes não foram alteradas automaticamente. Edite manualmente se necessário.");
              editId = null;
              clearLendingForm();
              loadLendings(user.uid);
            });
          } else {
            push(baseRef).then(newRef => {
              const lendingId = newRef.key;
              set(newRef, data).then(() => {
                generateInstallments(user.uid, lendingId, amount, installmentsCount, startDate, endDate);
                alert("Empréstimo registrado com parcelas geradas!");
                clearLendingForm();
                loadLendings(user.uid);
              });
            });
          }
        } else {
          alert("Preencha todos os campos obrigatórios.");
        }
      };

      function calculateEndDateFromStart(startDateStr, count) {
        const start = new Date(startDateStr);
        start.setMonth(start.getMonth() + (count - 1));
        return start.toISOString().split('T')[0];
      }

      function generateInstallments(uid, lendingId, totalAmount, count, startDate, endDate) {
        const installmentAmount = totalAmount / count;
        const start = new Date(startDate);
        for (let i = 1; i <= count; i++) {
          const dueDate = new Date(start);
          dueDate.setMonth(start.getMonth() + (i - 1));
          const dueDateStr = dueDate.toISOString().split('T')[0];
          const instData = {
            number: i,
            amount: installmentAmount,
            dueDate: dueDateStr,
            status: 'pending'
          };
          const installmentsRef = ref(db, `financas/${uid}/lendings/${lendingId}/installments`);
          const newInstRef = push(installmentsRef);
          set(newInstRef, instData);
        }
      }

      window.editLending = (id) => {
        const item = currentData.lendings.find(l => l.id === id);
        if (item) {
          document.getElementById("lendingPersonId").value = item.personId;
          document.getElementById("lendingAmount").value = item.amount;
          document.getElementById("lendingInstallments").value = item.installmentsCount;
          document.getElementById("lendingStartDate").value = item.startDate;
          calculateEndDate();
          editId = id;
        }
      };
      window.deleteLending = (id) => {
        if (confirm("Excluir empréstimo e parcelas?")) {
          remove(ref(db, `financas/${auth.currentUser.uid}/lendings/${id}`)).then(() => {
            loadLendings(auth.currentUser.uid);
          });
        }
      };
      window.markInstallmentPaid = (lendingId, instId) => {
        update(ref(db, `financas/${auth.currentUser.uid}/lendings/${lendingId}/installments/${instId}`), {
          status: 'paid'
        }).then(() => {
          alert("Parcela marcada como paga!");
          // loadLendings called via onValue
        });
      };
      window.editInstallment = (lendingId, instId, currentAmount, currentDueDate) => {
        const newAmount = prompt("Novo valor da parcela:", currentAmount);
        const newDueDate = prompt("Nova data de vencimento (YYYY-MM-DD):", currentDueDate);
        if (newAmount !== null && newDueDate !== null) {
          const parsedAmount = parseFloat(newAmount);
          if (!isNaN(parsedAmount)) {
            update(ref(db, `financas/${auth.currentUser.uid}/lendings/${lendingId}/installments/${instId}`), {
              amount: parsedAmount,
              dueDate: newDueDate
            }).then(() => {
              alert("Parcela atualizada!");
            }).catch(err => alert("Erro ao atualizar: " + err.message));
          } else {
            alert("Valor inválido.");
          }
        }
      };

      function clearLendingForm() {
        document.getElementById("lendingPersonId").value = "";
        document.getElementById("lendingAmount").value = "";
        document.getElementById("lendingInstallments").value = "";
        document.getElementById("lendingStartDate").value = "";
        document.getElementById("lendingEndDate").value = "";
      }

      // Função para formatar data para DD/MM/YYYY
      function formatDate(dateStr) {
        if (!dateStr) return 'N/A';
        const [year, month, day] = dateStr.split('-');
        return `${day}/${month}/${year}`;
      }

      // Funções auxiliares
      function getBankName(bankId) {
        const bank = currentData.banks.find(b => b.id === bankId);
        return bank ? bank.name : 'Desconhecido';
      }

      function getPersonName(personId) {
        const person = currentData.people.find(p => p.id === personId);
        return person ? person.name : 'Desconhecido';
      }

      function updateBankBalance(uid, bankId, amount, add) {
        const bankRef = ref(db, `financas/${uid}/banks/${bankId}`);
        onValue(bankRef, snapshot => {
          if (snapshot.exists()) {
            let balance = snapshot.val().balance;
            balance = add ? balance + amount : balance - amount;
            update(bankRef, {
              balance
            });
          }
        }, {
          onlyOnce: true
        });
      }

      // Exportação para PDF
      document.getElementById("exportPdfBtn").onclick = async () => {
        const {
          jsPDF
        } = window.jspdf;
        const doc = new jsPDF();
        let startY = 10;
        doc.setFontSize(16);
        doc.text("Relatório Financeiro", 10, startY);
        startY += 10;

        // Bancos
        doc.setFontSize(12);
        doc.text("Bancos:", 10, startY);
        startY += 10;
        const bankColumns = ["Nome", "Saldo"];
        const bankRows = currentData.banks.map(b => [b.name, `R$ ${b.balance.toFixed(2)}`]);
        doc.autoTable({
          head: [bankColumns],
          body: bankRows,
          startY
        });

        // Pessoas
        startY = doc.lastAutoTable.finalY + 10;
        doc.text("Pessoas:", 10, startY);
        startY += 10;
        const peopleColumns = ["Nome", "Telefone"];
        const peopleRows = currentData.people.map(p => [p.name, p.phone || 'N/A']);
        doc.autoTable({
          head: [peopleColumns],
          body: peopleRows,
          startY
        });

        // Entradas
        startY = doc.lastAutoTable.finalY + 10;
        doc.text("Entradas:", 10, startY);
        startY += 10;
        const incomeColumns = ["Data", "Valor", "Tipo", "Banco"];
        const incomeRows = currentData.incomes.map(i => [formatDate(i.date), `R$ ${i.amount.toFixed(2)}`, i.type, getBankName(i.bankId)]);
        doc.autoTable({
          head: [incomeColumns],
          body: incomeRows,
          startY
        });

        // Transferências
        startY = doc.lastAutoTable.finalY + 10;
        doc.text("Transferências:", 10, startY);
        startY += 10;
        const transferColumns = ["Data", "De", "Para", "Valor"];
        const transferRows = currentData.transfers.map(t => [formatDate(t.date), getBankName(t.fromBankId), getBankName(t.toBankId), `R$ ${t.amount.toFixed(2)}`]);
        doc.autoTable({
          head: [transferColumns],
          body: transferRows,
          startY
        });

        // Gastos
        startY = doc.lastAutoTable.finalY + 10;
        doc.text("Gastos:", 10, startY);
        startY += 10;
        const expenseColumns = ["Data", "Valor", "Categoria", "Descrição", "Banco"];
        const expenseRows = currentData.expenses.map(e => [formatDate(e.date), `R$ ${e.amount.toFixed(2)}`, e.category, e.description || 'N/A', getBankName(e.bankId)]);
        doc.autoTable({
          head: [expenseColumns],
          body: expenseRows,
          startY
        });

        // Empréstimos
        startY = doc.lastAutoTable.finalY + 10;
        doc.text("Empréstimos:", 10, startY);
        startY += 10;
        const lendingColumns = ["Pessoa", "Valor Total", "Data Início", "Data Término", "Parcelas"];
        const lendingRows = currentData.lendings.map(l => [getPersonName(l.personId), `R$ ${l.amount.toFixed(2)}`, formatDate(l.startDate), formatDate(l.endDate), l.installmentsCount]);
        doc.autoTable({
          head: [lendingColumns],
          body: lendingRows,
          startY
        });

        doc.save("relatorio_financeiro.pdf");
      };

      // Exportação para Excel
      document.getElementById("exportExcelBtn").onclick = () => {
        const workbook = XLSX.utils.book_new();

        // Bancos
        const bankSheet = XLSX.utils.json_to_sheet(currentData.banks.map(b => ({
          Nome: b.name,
          Saldo: b.balance
        })));
        XLSX.utils.book_append_sheet(workbook, bankSheet, "Bancos");

        // Pessoas
        const peopleSheet = XLSX.utils.json_to_sheet(currentData.people.map(p => ({
          Nome: p.name,
          Telefone: p.phone
        })));
        XLSX.utils.book_append_sheet(workbook, peopleSheet, "Pessoas");

        // Entradas
        const incomeSheet = XLSX.utils.json_to_sheet(currentData.incomes.map(i => ({
          Data: formatDate(i.date),
          Valor: i.amount,
          Tipo: i.type,
          Banco: getBankName(i.bankId)
        })));
        XLSX.utils.book_append_sheet(workbook, incomeSheet, "Entradas");

        // Transferências
        const transferSheet = XLSX.utils.json_to_sheet(currentData.transfers.map(t => ({
          Data: formatDate(t.date),
          De: getBankName(t.fromBankId),
          Para: getBankName(t.toBankId),
          Valor: t.amount
        })));
        XLSX.utils.book_append_sheet(workbook, transferSheet, "Transferências");

        // Gastos
        const expenseSheet = XLSX.utils.json_to_sheet(currentData.expenses.map(e => ({
          Data: formatDate(e.date),
          Valor: e.amount,
          Categoria: e.category,
          Descrição: e.description,
          Banco: getBankName(e.bankId)
        })));
        XLSX.utils.book_append_sheet(workbook, expenseSheet, "Gastos");

        // Empréstimos
        const lendingSheet = XLSX.utils.json_to_sheet(currentData.lendings.map(l => ({
          Pessoa: getPersonName(l.personId),
          "Valor Total": l.amount,
          "Data Início": formatDate(l.startDate),
          "Data Término": formatDate(l.endDate),
          Parcelas: l.installmentsCount
        })));
        XLSX.utils.book_append_sheet(workbook, lendingSheet, "Empréstimos");

        XLSX.writeFile(workbook, "relatorio_financeiro.xlsx");
      };

      // Enviar relatório por número
      document.getElementById("sendReportBtn").onclick = () => {
        const phoneNumber = document.getElementById("phoneNumber").value.trim();
        if (!phoneNumber) {
          alert("Por favor, insira um número de telefone.");
          return;
        }
        let reportMessage = "Relatório Financeiro:\n\n";

        // Bancos
        reportMessage += "Bancos:\n";
        currentData.banks.forEach(b => {
          reportMessage += `Nome: ${b.name}, Saldo: R$ ${b.balance.toFixed(2)}\n`;
        });
        reportMessage += "--------------------------------------\n";

        // Pessoas
        reportMessage += "Pessoas:\n";
        currentData.people.forEach(p => {
          reportMessage += `Nome: ${p.name}, Telefone: ${p.phone || 'N/A'}\n`;
        });
        reportMessage += "--------------------------------------\n";

        // Entradas
        reportMessage += "Entradas:\n";
        currentData.incomes.forEach(i => {
          reportMessage += `Data: ${formatDate(i.date)}, Valor: R$ ${i.amount.toFixed(2)}, Tipo: ${i.type}, Banco: ${getBankName(i.bankId)}\n`;
        });
        reportMessage += "--------------------------------------\n";

        // Transferências
        reportMessage += "Transferências:\n";
        currentData.transfers.forEach(t => {
          reportMessage += `Data: ${formatDate(t.date)}, De: ${getBankName(t.fromBankId)}, Para: ${getBankName(t.toBankId)}, Valor: R$ ${t.amount.toFixed(2)}\n`;
        });
        reportMessage += "--------------------------------------\n";

        // Gastos
        reportMessage += "Gastos:\n";
        currentData.expenses.forEach(e => {
          reportMessage += `Data: ${formatDate(e.date)}, Valor: R$ ${e.amount.toFixed(2)}, Categoria: ${e.category}, Descrição: ${e.description || 'N/A'}\n`;
        });
        reportMessage += "--------------------------------------\n";

        // Empréstimos
        reportMessage += "Empréstimos:\n";
        currentData.lendings.forEach(l => {
          reportMessage += `Pessoa: ${getPersonName(l.personId)}, Valor Total: R$ ${l.amount.toFixed(2)}, Início: ${formatDate(l.startDate)}, Término: ${formatDate(l.endDate)}, Parcelas: ${l.installmentsCount}\n`;
        });
        reportMessage += "--------------------------------------\n";

        const confirmSend = confirm("Isso abrirá o WhatsApp com a mensagem preenchida. Deseja continuar?");
        if (confirmSend) {
          const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(reportMessage)}`;
          window.open(whatsappUrl, '_blank');
        }
      };

      // Modo escuro
      const themeToggle = document.getElementById("themeToggle");
      themeToggle.addEventListener("click", () => {
        const currentTheme = document.body.getAttribute("data-theme") || "light";
        const newTheme = currentTheme === "light" ? "dark" : "light";
        document.body.setAttribute("data-theme", newTheme);
        themeToggle.innerHTML = newTheme === "light" ? '<i class="fas fa-moon"></i>' : '<i class="fas fa-sun"></i>';
        localStorage.setItem("theme", newTheme);
      });
      const savedTheme = localStorage.getItem("theme") || "light";
      document.body.setAttribute("data-theme", savedTheme);
      themeToggle.innerHTML = savedTheme === "light" ? '<i class="fas fa-moon"></i>' : '<i class="fas fa-sun"></i>';

      // Accordion
      document.querySelectorAll(".accordion-header").forEach(header => {
        header.addEventListener("click", () => {
          const content = header.nextElementSibling;
          content.classList.toggle("active");
        });
      });
    </script>

  </body>

</html>